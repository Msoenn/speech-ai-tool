name: Bump Version & Tag Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g. 0.3.1) — without the 'v' prefix"
        required: true
        type: string
      bump_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - minor
          - patch
          - major
        default: patch

permissions:
  contents: write

jobs:
  bump-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate version format
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format '$VERSION'. Use semver like 0.3.1"
            exit 1
          fi
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "::error::Tag v$VERSION already exists"
            exit 1
          fi

      - name: Bump version in project files
        run: |
          VERSION="${{ inputs.version }}"

          # package.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json

          # src-tauri/tauri.conf.json
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json

          # src-tauri/Cargo.toml (only the package version, not dependency versions)
          sed -i "0,/^version = \".*\"/s//version = \"$VERSION\"/" src-tauri/Cargo.toml

          # Update Cargo.lock
          sed -i "0,/^name = \"speech-ai-tool\"/{/^name = \"speech-ai-tool\"/{n;s/^version = \".*\"/version = \"$VERSION\"/}}" src-tauri/Cargo.lock

      - name: Commit and tag
        run: |
          VERSION="${{ inputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json src-tauri/tauri.conf.json src-tauri/Cargo.toml src-tauri/Cargo.lock
          git commit -m "chore: bump version to v$VERSION"
          git tag "v$VERSION"
          git push
          git push origin "v$VERSION"

      - name: Summary
        run: |
          VERSION="${{ inputs.version }}"
          echo "### Released v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "Tag \`v$VERSION\` pushed — the [Release workflow](../actions/workflows/release.yml) will now build and publish." >> $GITHUB_STEP_SUMMARY
